# 壁纸图库优化与工程化计划

## 上下文
- **项目**: wallpaper-gallery (Vue 3 + Vite)
- **目标**: 修复缩略图显示、分辨率准确性、工程化配置
- **创建时间**: 2024-12-19

---

## P0 - Bug修复（高优先级）

### P0-1: 图片代理服务集成

**目标**: 缩略图快速加载，原图按需加载

**修改文件**:
- `src/utils/constants.js` - 新增图片代理配置
- `src/components/wallpaper/WallpaperCard.vue` - 使用缩略图URL
- `src/components/wallpaper/WallpaperModal.vue` - 保持原图URL

**原子操作**:
1. constants.js 新增:
   ```js
   // 图片代理服务（生成缩略图）
   export const IMAGE_PROXY = {
     BASE_URL: 'https://wsrv.nl/',
     THUMB_WIDTH: 400,
     THUMB_QUALITY: 80,
     FORMAT: 'webp'
   }

   // 生成缩略图URL
   export function getThumbnailUrl(originalUrl) {
     const params = new URLSearchParams({
       url: originalUrl,
       w: IMAGE_PROXY.THUMB_WIDTH,
       q: IMAGE_PROXY.THUMB_QUALITY,
       output: IMAGE_PROXY.FORMAT
     })
     return `${IMAGE_PROXY.BASE_URL}?${params}`
   }
   ```

2. WallpaperCard.vue 修改:
   - 导入 `getThumbnailUrl`
   - 新增 computed: `thumbnailUrl`
   - img src 改为 `thumbnailUrl`

**预期结果**: 缩略图体积从 5-15MB 降至 50-150KB，加载速度提升 10x+

---

### P0-2: 分辨率标签准确性修复

**目标**: 显示图片真实分辨率

**修改文件**:
- `src/components/wallpaper/WallpaperCard.vue`

**原子操作**:
1. 新增 ref: `actualDimensions = ref({ width: 0, height: 0 })`
2. 修改 `handleImageLoad`:
   ```js
   const handleImageLoad = (e) => {
     imageLoaded.value = true
     if (e.target) {
       actualDimensions.value = {
         width: e.target.naturalWidth,
         height: e.target.naturalHeight
       }
     }
   }
   ```
3. 修改 computed `resolution`:
   ```js
   const resolution = computed(() => {
     if (actualDimensions.value.width > 0) {
       return getResolutionLabel(actualDimensions.value.width, actualDimensions.value.height)
     }
     return props.wallpaper.resolution || { label: '1080P' }
   })
   ```

**预期结果**: 图片加载后显示真实分辨率

---

### P0-3: GitHub 链接修正

**修改文件**:
- `src/components/layout/AppHeader.vue`

**原子操作**:
- 第44行: `href` 改为 `https://github.com/IT-NuanxinPro/wallpaper-gallery`

---

## P1 - 优化（中优先级）

### P1-1: 分辨率标签层级重构

**修改文件**:
- `src/utils/format.js` - 新增 `getResolutionLabel` 函数
- `src/utils/constants.js` - 新增分辨率阈值常量

**原子操作**:
1. constants.js 新增:
   ```js
   export const RESOLUTION_THRESHOLDS = [
     { minWidth: 5120, label: '5K+', type: 'danger' },
     { minWidth: 3840, label: '4K+', type: 'warning' },
     { minWidth: 2560, label: '4K', type: 'success' },
     { minWidth: 1920, label: '超清', type: 'info' },
     { minWidth: 1280, label: '高清', type: 'primary' },
     { minWidth: 0, label: '标清', type: 'secondary' }
   ]
   ```

2. format.js 新增:
   ```js
   export function getResolutionLabel(width, height) {
     const w = Math.max(width, height) // 取长边
     for (const threshold of RESOLUTION_THRESHOLDS) {
       if (w >= threshold.minWidth) {
         return { width, height, label: threshold.label, type: threshold.type }
       }
     }
     return { width, height, label: '标清', type: 'secondary' }
   }
   ```

3. 更新 WallpaperCard.vue 和 WallpaperModal.vue 使用新函数

---

## P2 - 工程化（低优先级）

### P2-1: 迁移到 pnpm

**操作步骤**:
1. 删除 `package-lock.json` 和 `node_modules`
2. 安装 pnpm: `npm install -g pnpm`
3. 执行 `pnpm install`
4. 更新 package.json scripts（如需要）

---

### P2-2: ESLint v9 + Prettier

**新增文件**:
- `eslint.config.js` (flat config)
- `.vscode/settings.json` (编辑器集成)

**依赖安装**:
```bash
pnpm add -D eslint @antfu/eslint-config
```

**eslint.config.js**:
```js
import antfu from '@antfu/eslint-config'

export default antfu({
  vue: true,
  formatters: true,
  stylistic: {
    indent: 2,
    quotes: 'single',
    semi: false
  }
})
```

---

### P2-3: Husky + lint-staged

**依赖安装**:
```bash
pnpm add -D husky lint-staged
pnpm exec husky init
```

**配置文件**:
- `.husky/pre-commit`
- `package.json` 新增 lint-staged 配置

---

### P2-4: Vite 打包优化

**修改文件**:
- `vite.config.js`

**依赖安装**:
```bash
pnpm add -D vite-plugin-compression rollup-plugin-visualizer
```

**优化内容**:
1. Gzip/Brotli 压缩
2. 打包分析（可选）
3. 代码分割优化
4. 生产环境移除 console

---

## 执行顺序

```
Phase 1 (Bug修复):
  P0-3 → P0-1 → P0-2 → P1-1

Phase 2 (工程化):
  P2-1 → P2-2 → P2-3 → P2-4
```

---

## 验收标准

- [ ] 缩略图 < 200KB，秒级加载
- [ ] 分辨率标签准确反映真实尺寸
- [ ] GitHub 链接正确跳转
- [ ] ESLint 检查通过
- [ ] Git commit 触发 lint 检查
- [ ] 打包体积优化（对比前后）
